<script>
    // Fonction pour récupérer les paramètres d'URL
    function getUrlParameter(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    }

    const directionImages = {
        up: "https://raw.githubusercontent.com/Anngeldouche/StardewP2/main/Copainbits/Copains8B(1)B.png", // Dos
        down: "https://raw.githubusercontent.com/Anngeldouche/StardewP2/main/Copainbits/Copains8B(1).png", // Face
        left: "https://raw.githubusercontent.com/Anngeldouche/StardewP2/main/Copainbits/Copains8B(1)G.png", // Gauche
        right: "https://raw.githubusercontent.com/Anngeldouche/StardewP2/main/Copainbits/Copains8B(1)D.png", // Droite
    };

    const copains = {
        "1": "Angle",
        "2": "Chim",
        "3": "Zonzon",
        "4": "Luc",
        "5": "Mori"
    };

    const characterId = getUrlParameter('character');
    const image = getUrlParameter('image');
    const displayElement = document.getElementById('character-display');

    if (characterId && image) {
        const characterName = copains[characterId] || "Copain inconnu";
        displayElement.innerHTML = `
            <img src="${image}" alt="Personnage sélectionné" id="character-image" />
            <h2>Bienvenue ${characterName}</h2>
        `;

        const characterImage = document.getElementById('character-image');
        let offsetX, offsetY;

        characterImage.addEventListener('mousedown', (event) => {
            offsetX = event.clientX - characterImage.getBoundingClientRect().left;
            offsetY = event.clientY - characterImage.getBoundingClientRect().top;

            const onMouseMove = (event) => {
                characterImage.style.left = `${event.clientX - offsetX}px`;
                characterImage.style.top = `${event.clientY - offsetY}px`;
            };

            const onMouseUp = () => {
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', onMouseUp);
            };

            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
        });

    } else {
        displayElement.innerHTML = `<p>Aucun personnage sélectionné. Veuillez revenir à la page précédente et en choisir un.</p>`;
    }

    let intervalId;

    document.getElementById("up").addEventListener("mousedown", () => startMoving("up"));
    document.getElementById("down").addEventListener("mousedown", () => startMoving("down"));
    document.getElementById("left").addEventListener("mousedown", () => startMoving("left"));
    document.getElementById("right").addEventListener("mousedown", () => startMoving("right"));

    document.getElementById("up").addEventListener("mouseup", stopMoving);
    document.getElementById("down").addEventListener("mouseup", stopMoving);
    document.getElementById("left").addEventListener("mouseup", stopMoving);
    document.getElementById("right").addEventListener("mouseup", stopMoving);

    document.getElementById("up").addEventListener("mouseleave", stopMoving);
    document.getElementById("down").addEventListener("mouseleave", stopMoving);
    document.getElementById("left").addEventListener("mouseleave", stopMoving);
    document.getElementById("right").addEventListener("mouseleave", stopMoving);

    function startMoving(direction) {
        intervalId = setInterval(() => moveCharacter(direction), 50);
    }

    function stopMoving() {
        clearInterval(intervalId);
    }

    function moveCharacter(direction) {
        const characterImage = document.getElementById('character-image');
        let currentPosition = characterImage.getBoundingClientRect();

        // Change l'image en fonction de la direction
        characterImage.src = directionImages[direction];

        switch (direction) {
            case "up":
                characterImage.style.top = `${currentPosition.top - 10}px`;
                break;
            case "down":
                characterImage.style.top = `${currentPosition.top + 10}px`;
                break;
            case "left":
                characterImage.style.left = `${currentPosition.left - 10}px`;
                break;
            case "right":
                characterImage.style.left = `${currentPosition.left + 10}px`;
                break;
        }
    }

    const keysPressed = {
        ArrowUp: false,
        ArrowDown: false,
        ArrowLeft: false,
        ArrowRight: false,
    };

    window.addEventListener('keydown', (event) => {
        event.preventDefault();
        if (event.key in keysPressed) {
            keysPressed[event.key] = true;
            moveCharacterBasedOnKeys();
        }
    });

    window.addEventListener('keyup', (event) => {
        if (event.key in keysPressed) {
            keysPressed[event.key] = false;
        }
    });

    function moveCharacterBasedOnKeys() {
        const characterImage = document.getElementById('character-image');
        let currentPosition = characterImage.getBoundingClientRect();
        let moveX = 0;
        let moveY = 0;

        if (keysPressed.ArrowUp) {
            moveY -= 10;
            characterImage.src = directionImages["up"];
        }
        if (keysPressed.ArrowDown) {
            moveY += 10;
            characterImage.src = directionImages["down"];
        }
        if (keysPressed.ArrowLeft) {
            moveX -= 10;
            characterImage.src = directionImages["left"];
        }
        if (keysPressed.ArrowRight) {
            moveX += 10;
            characterImage.src = directionImages["right"];
        }

        characterImage.style.left = `${currentPosition.left + moveX}px`;
        characterImage.style.top = `${currentPosition.top + moveY}px`;
    }
</script>
